<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Making PPXs Portable with ocaml-migrate-parsetree</title>
  <meta name="description" content="An effort to make PPXs portable across compiler versions.">
  <!-- todo: include this into main.css -->
  <link rel="stylesheet" href="/css/font-awesome.css">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://ocamllabs.github.io//projects/2017/02/15/ocaml-migrate-parsetree.html">
  <link rel="alternate" type="application/rss+xml" title="OCaml Labs" href="https://ocamllabs.github.io//feed.xml">
</head>

  <body>
    <div class="page-content">
      <div class="container">
        <div class="three columns">
          <header class="site-header">

  <h2 class="logo">
   <a href="/">OCaml Labs</a><br />
   
   <img width="100px" src="/assets/img/origami-camel.png" />
   
  </h2>

  <div class="nav">
    
    <label for="menu-toggle" class="menu-icon">
        <!--div data-icon="ei-navicon"></div-->
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
    </label>
    <input type="checkbox" id="menu-toggle">

    <div class="site-nav">
      <nav>
        <ul class="page-link">
          <li><a href="/">Home</a></li>
          <li><a href="/news">News</a></li>
          <li><a href="/doc">Projects</a></li>
          <li><a href="/community">Community</a></li>
          <li><a href="/people">People</a></li>
          <li><a href="/papers">Papers</a></li>
          <li><a href="/talks">Talks</a></li>
          <li><a href="/about">About</a></li>
          <li><a href="/feed.xml">RSS</a></li>
        </ul>
      </nav>
    </div>

  </div>
</header>

        </div>

        <div class="nine columns" style="z-index:100;">
          <div class="wrapper">
            <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="article_header">
    <h1 class="article_title" itemprop="name headline">Making PPXs Portable with ocaml-migrate-parsetree</h1>
    <p class="article_meta"><time datetime="2017-02-15T00:00:00+00:00" itemprop="datePublished">Feb 15, 2017</time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">let-def</span></span></p>
  </header>

  <div class="article-content" itemprop="articleBody">
    <p>An effort to make PPXs portable across compiler versions.</p>

<p>PPX extensions work by receiving a syntax tree from the compiler, rewriting it, and sending it back. Extensions obtain the definition of the syntax tree as well as some helpers from compiler-libs. Thus they tend to depend on the internal of the compiler.</p>

<p>PPX developers often have to maintain separate code for each version of the compiler they want to support. When a new compiler version is introduced, most opam packages are unavailable because of PPX breakage.</p>

<p>To address these two problems <a href="https://github.com/let-def/ocaml-migrate-parsetree">ocaml-migrate-parsetree</a> versions the syntax tree and provides conversion functions.
Migrating to a new version always succeeds, migrating to an older version fails if some features in use are not available.</p>

<p>Versions covered are 4.02, 4.03, 4.04 and trunk (4.05). A code working with 4.04 will work out of the box on 4.05. However, if the code later evolves to make use of 4.05 specific features, it will no longer be backwards compatible.</p>

<p>Features provided by <code class="highlighter-rouge">ocaml-migrate-parsetree</code> includes:</p>
<ul>
  <li>versioning of <code class="highlighter-rouge">Asttypes</code>, <code class="highlighter-rouge">Parsetree</code>, <code class="highlighter-rouge">Ast_helper</code>, <code class="highlighter-rouge">Outcometree</code> and parts of <code class="highlighter-rouge">Ast_mapper</code> and <code class="highlighter-rouge">Docstrings</code></li>
  <li>unmarshalling of any supported versions of syntax trees</li>
  <li>conversion of parsetrees and lifting of <code class="highlighter-rouge">Ast_mapper.mapper</code> between arbitrary versions.</li>
</ul>

<p>For <code class="highlighter-rouge">Ast_mapper</code> and <code class="highlighter-rouge">Docstrings</code>, anything relying on global state has been removed. Lifting of <code class="highlighter-rouge">Ast_mapper.mapper</code> breaks the open recursion (the Ast is converted to the targeted version only once when entering the mapper and converted back when leaving).</p>

<h2 id="minimal-guide-to-porting-a-ppx-extension">Minimal guide to porting a PPX extension</h2>

<p>Porting is easy as long as you stick to modules that are versioned by <em>ocaml-migrate-parsetree</em>. It is trivial if you make direct use of <code class="highlighter-rouge">Ast_mapper</code>. However using <code class="highlighter-rouge">Ast_mapper_class</code> from <a href="https://github.com/alainfrisch/ppx_tools">ppx_tools</a> breaks this approach.</p>

<p>Starting from a PPX written against OCaml 4.04, porting amounts to:</p>

<div class="language-ocaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">(* Shadowing compiler-libs modules with the ones versioned for 4.04 *)</span>
<span class="k">open</span> <span class="nc">Migrate_parsetree</span>
<span class="k">open</span> <span class="nn">Ast_404</span>

<span class="p">...</span> <span class="p">(</span><span class="o">*</span> <span class="n">your</span> <span class="n">ppx</span> <span class="n">code</span> <span class="o">*</span><span class="p">)</span>

<span class="c">(* ########################################### *)</span>
<span class="c">(* Registering the mapper with the host version of compiler-libs

   Original code:
   let () =
     Ast_mapper.run_main @@ fun _ -&gt; my_mapper
*)</span>

<span class="c">(* Create a module converting structures from 4.04 to current version *)</span>
<span class="k">module</span> <span class="nc">To_current</span> <span class="o">=</span> <span class="nc">Convert</span><span class="p">(</span><span class="nc">OCaml_404</span><span class="p">)(</span><span class="nc">OCaml_current</span><span class="p">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* Original Ast_mapper is shadowed.
     Compiler_libs module provides aliase to the original one. *)</span>
  <span class="nn">Compiler_libs</span><span class="p">.</span><span class="nn">Ast_mapper</span><span class="p">.</span><span class="n">run_main</span> <span class="o">@@</span> <span class="k">fun</span> <span class="n">_</span> <span class="o">-&gt;</span>
  <span class="c">(* Finally lift the mapper *)</span>
  <span class="nn">To_current</span><span class="p">.</span><span class="n">copy_mapper</span> <span class="n">my_mapper</span>

<span class="c">(* ########################################### *)</span>
<span class="c">(* Alternatively, if the implementation uses Ast_mapper.register:

   let () = Ast_mapper.register "my_mapper" mapper
*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">module</span> <span class="nc">To_current</span> <span class="o">=</span> <span class="nc">Convert</span><span class="p">(</span><span class="nc">OCaml_404</span><span class="p">)(</span><span class="nc">OCaml_current</span><span class="p">)</span> <span class="k">in</span>
  <span class="nn">Compiler_libs</span><span class="p">.</span><span class="nn">Ast_mapper</span><span class="p">.</span><span class="n">register</span> <span class="s2">"my_mapper"</span> <span class="p">(</span><span class="nn">To_current</span><span class="p">.</span><span class="n">copy_mapper</span> <span class="n">mapper</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="future-work">Future work</h2>

<p>While a few PPX extensions have already been ported, the ones relying on <code class="highlighter-rouge">Ast_mapper_class</code> are not handled yet. Porting more of them and agreeing on a reasonable set of features to cover most use cases is a prerequisite before a 1.0 release.</p>

<p>Another axis is the handling of unsupported features. As of today, converting an unsupported feature raises an exception. Some PPX extensions could opt-in a softer policy of encoding new constructions as attributes. This make sense when using an old PPX with a new version of the compiler.</p>

  </div>

  <div class="article-related">Related Posts</div>
  <ul>
   
     <li><a href="/general/2017/12/14/DerivingCrowbar.html">testing ocaml-migrate-parsetree with `ppx_deriving_crowbar`</a></li>
   
     <li><a href="/general/2017/10/30/WindowsUnicode.html">Windows Unicode Support - A Bug-Fix 12 Years in the Making</a></li>
   
     <li><a href="/general/2017/10/24/Bun.html">Fuzzing for CI Workflows</a></li>
   
     <li><a href="/general/2017/09/27/GithubCI.html">Testing Your Own Fork With OCaml's GitHub CI</a></li>
   
     <li><a href="/general/2017/09/04/OcalPlatformPackaging.html">Platforms, Packaging, Progress</a></li>
   
     <li><a href="/general/2017/08/25/Merlin3WindowsSupport.html">Merlin 3.0.0 on Windows</a></li>
   
     <li><a href="/rfc/2017/07/27/NewGitRFC.html">A New Implementation of Git</a></li>
   
     <li><a href="/releases/2017/07/19/MirageOSLibraryReleases.html">Major Releases of Cohttp, Conduit, DNS and TCP/IP Libraries</a></li>
   
     <li><a href="/releases/2017/07/13/ocaml4.05.html">OCaml 4.05.0 Released</a></li>
   
     <li><a href="/general/2017/06/26/IntelHyperThreadBug.html">Intel Hyper-Threading Bug Uncovered by OCaml Developers</a></li>
   
  </ul>

  <footer class="article-footer">

  <section class="share">
  <a class="share-link" href="" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
    Twitter
  </a>
  <a class="share-link" href="" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
    Facebook
  </a>
  <a class="share-link" href="" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530'); return false;">
    Google+
  </a> 
</section>


  <hr/>

  
<section class="author">
  <div class="authorimage box" style="background: url(/assets/img/let-def.png)"></div>
  <div class="authorinfo box">
    <p>Author | <a href="">Frédéric Bour</a></p>
    <p class="bio"><p>Fred develops <a href="https://github.com/ocaml/merlin">Merlin</a> and a few other OCaml tools with OCaml Labs</p>
</p>
  </div>
</section>


  </footer>

</article>

          </div>
        </div>
      </div>
      <footer class="site-footer">
  <div class="container">
    <div class="footer left column one-half">
      <section class="small-font">
        Content © 2012-2017 under a <a href="https://wiki.creativecommons.org/wiki/CC0">CC0</a> license.<br />
        Theme based on <a href="https://github.com/wild-flame/jekyll-simple">Jekyll-Simple</a> by <a href="http://wildflame.me">wildflame</a>.
      </section>
    </div>

    <div class="footer right column one-half">
      <section class="small-font">
        
        <a href="https://github.com/ocamllabs"><i class="fa fa-github fa-2x"></i></a>
        
        
        <a href="https://twitter.com/ocamllabs"><i class="fa fa-twitter fa-2x"></i></a>
        
      </section>
    </div>
  </div>
</footer>
 
    </div>
  </body>
</html>
